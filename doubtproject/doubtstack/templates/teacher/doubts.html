{% extends 'teacher/base.html' %}
{% block title %}Doubts Dashboard – DoubtStack{% endblock %}

{% block content %}
<section class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h2 class="text-2xl font-semibold text-teal-400 neon-text">Doubts Dashboard</h2>
      <p class="text-gray-400">Welcome, {{ teacher.name }} ({{ teacher.role }})</p>
    </div>
    <div class="text-sm text-gray-400">
      {% if is_hod %}
        Viewing: <strong>All Subjects</strong>
      {% else %}
        Viewing: <strong>Your Subjects</strong>
      {% endif %}
    </div>
  </div>

  <!-- Filter Form -->
  <form method="GET" id="filterForm" class="flex flex-wrap gap-3 mb-6 items-center bg-gray-800/50 p-4 rounded-lg border border-gray-700">
    <select name="subject_id" class="bg-gray-900 text-gray-200 p-2 rounded-md border border-gray-700 focus:outline-none focus:ring-1 focus:ring-teal-500">
      <option value="">All Subjects</option>
      {% for subj in subjects %}
        <option value="{{ subj.id }}" {% if request.GET.subject_id == subj.id|stringformat:"s" %}selected{% endif %}>
          {{ subj.name }}{% if subj.code %} ({{ subj.code }}){% endif %}
        </option>
      {% endfor %}
    </select>

    <select name="status" class="bg-gray-900 text-gray-200 p-2 rounded-md border border-gray-700 focus:outline-none focus:ring-1 focus:ring-teal-500">
      <option value="">All Status</option>
      <option value="unresolved" {% if request.GET.status == 'unresolved' %}selected{% endif %}>Unresolved</option>
      <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>Resolved</option>
      <option value="escalated" {% if request.GET.status == 'escalated' %}selected{% endif %}>Escalated</option>
    </select>

    <select name="sort" class="bg-gray-900 text-gray-200 p-2 rounded-md border border-gray-700 focus:outline-none focus:ring-1 focus:ring-teal-500">
      <option value="">Sort by</option>
      <option value="latest" {% if request.GET.sort == 'latest' %}selected{% endif %}>Latest</option>
      <option value="votes" {% if request.GET.sort == 'votes' %}selected{% endif %}>Most Voted</option>
    </select>

    <button type="submit" class="bg-gradient-to-r from-purple-500 to-blue-500 px-4 py-2 rounded-lg text-white font-medium hover:opacity-90 transition-all">
      <i class="fa-solid fa-filter mr-1"></i> Filter
    </button>

    <a href="{% url 'teacher_view_doubts' %}" class="ml-2 px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-gray-300 transition">
      <i class="fa-solid fa-rotate-right mr-1"></i> Reset
    </a>
  </form>

  <!-- Doubts List -->
  <div id="doubtsContainer" class="grid gap-4">
    {% for doubt in doubts %}
    <div class="bg-gray-800 p-5 rounded-lg flex justify-between items-start gap-4 card-hover border border-gray-700 transition-transform">
      <div class="flex-1 min-w-0">
        <!-- Topic and Subject -->
        <div class="flex items-center justify-between">
          <h4 class="text-lg font-semibold text-white truncate">{{ doubt.topic|default:"(No topic)" }}</h4>
          <span class="text-sm text-gray-400 italic">{{ doubt.subject.name }}</span>
        </div>

        <!-- Doubt Text -->
        <p class="text-gray-300 mt-2 whitespace-pre-line">{{ doubt.text|truncatechars:400 }}</p>

        <!-- Posted Info -->
        <p class="text-sm text-gray-500 mt-3 flex items-center flex-wrap gap-2">
          <span class="font-semibold text-blue-500">Posted by:</span>
          <span class="font-medium text-gray-200">{{ doubt.student.name }}</span>
          {% if doubt.anonymous %}
            <span class="italic text-gray-400 bg-yellow-100/20 px-2 py-0.5 rounded-md text-xs border border-yellow-200/20">
              (Posted as Anonymous)
            </span>
          {% endif %}
          <span class="text-gray-400">• {{ doubt.created_at|timesince }} ago</span>
          <span class="text-gray-400">
            • Upvotes:
            <span class="font-semibold text-teal-400">
              {{ doubt.votes_count }}
            </span>
          </span>
        </p>

        <!-- Status Badge -->
        <div class="mt-3">
          <span class="inline-block px-3 py-1 text-xs rounded-full font-medium
                       {% if doubt.status == 'resolved' %}bg-green-600/80 text-green-50
                       {% elif doubt.status == 'unresolved' %}bg-red-600/80 text-red-50
                       {% else %}bg-yellow-600/80 text-yellow-50{% endif %}">
            {{ doubt.status|title }}
          </span>
        </div>
      </div>

      <!-- Right Side: Chat Button -->
      <div class="flex flex-col items-end gap-2">
        <a href="{% url 'teacher_reply_chat' doubt.id %}"
           class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm font-medium shadow-sm">
          <i class="fa-solid fa-comments mr-1"></i> View Chat
        </a>
        <small class="text-gray-500">{{ doubt.created_at|date:"M j, Y H:i" }}</small>
      </div>
    </div>
    {% empty %}
    <p class="text-gray-400 text-center py-6">No doubts found for the selected filters.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}
