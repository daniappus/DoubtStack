{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DoubtStack â€“ Login/Register</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">

  <div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-md space-y-6">

      <!-- Logo -->
      <div class="text-center mb-6">
        <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400">
          DoubtStack
        </h1>
        <p class="text-gray-400 mt-1">Ask Anything. Anytime. Without Fear.</p>
      </div>

      <!-- Step 1: Enter Register/Teacher Number -->
      <div id="step-number" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 {% if show_step != 'number' %}hidden{% endif %}">
        <h2 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">Enter Number</h2>
        <form id="numberForm" method="POST">
          {% csrf_token %}
          <div class="mb-4">{{ number_form.reg_no }}</div>
          <button type="submit" class="w-full px-4 py-3 bg-gradient-to-r from-blue-500 to-teal-400 text-white font-semibold rounded-lg hover:opacity-90 transition">
            Next
          </button>
        </form>
      </div>

      <!-- Step 2: OTP Verification -->
      <div id="step-otp" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 {% if show_step != 'otp' %}hidden{% endif %}">
        <h2 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">OTP Verification</h2>
        <p class="text-gray-300 mb-4">
          We sent a 6-digit OTP to your email: <span id="maskedEmail">{{ masked_email }}</span>
        </p>
        <form id="otpForm" method="POST">
          {% csrf_token %}
          <div class="mb-4">{{ otp_form.otp }}</div>
          <div class="flex justify-between items-center">
            <button type="submit" class="px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg hover:opacity-90 transition">
              Verify OTP
            </button>
            <button type="button" id="resendOtp" class="px-4 py-3 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 transition">Resend OTP</button>
          </div>
        </form>
      </div>

      <!-- Step 3: Set Password -->
      <div id="step-password" class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 {% if show_step != 'password' %}hidden{% endif %}">
        <h2 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-400">Set Password</h2>
        <form id="passwordForm" method="POST">
          {% csrf_token %}
          <div class="mb-4">{{ password_form.password }}</div>
          <div class="mb-4">{{ password_form.confirm_password }}</div>
          <button type="submit" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-teal-400 text-white font-semibold rounded-lg hover:opacity-90 transition">
            Set Password
          </button>
        </form>
      </div>

      <!-- Messages -->
      <div id="messageBox" class="mt-4"></div>

    </div>
  </div>

  <!-- AJAX Script -->
  <script>
    function showMessage(msg, color='red') {
      $('#messageBox').html(`<p class="text-sm text-${color}-400">${msg}</p>`);
    }

    // Step 1: Submit Register/Teacher Number
    $('#numberForm').submit(function(e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'number_submit' %}",
        type: "POST",
        data: $(this).serialize(),
        success: function(response){
          if(response.status === 'otp'){
            $('#step-number').hide();
            $('#step-otp').show();
            $('#maskedEmail').text(response.masked_email);
            showMessage('');
          } else if(response.status === 'login'){
            window.location.href = response.redirect_url;
          } else {
            showMessage(response.message);
          }
        }
      });
    });

    // Step 2: Submit OTP
    $('#otpForm').submit(function(e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'verify_otp' %}",
        type: "POST",
        data: $(this).serialize(),
        success: function(response){
          if(response.status === 'password'){
            $('#step-otp').hide();
            $('#step-password').show();
            showMessage('');
          } else {
            showMessage(response.message);
          }
        }
      });
    });

    // Resend OTP
    $('#resendOtp').click(function() {
      $.ajax({
        url: "{% url 'resend_otp' %}",
        type: "POST",
        data: {
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'reg_no': $('input[name="reg_no"]').val()
        },
        success: function(response){
          showMessage('OTP resent successfully!', 'green');
        }
      });
    });

    // Step 3: Submit Password
    $('#passwordForm').submit(function(e) {
      e.preventDefault();
      $.ajax({
        url: "{% url 'set_password' %}",
        type: "POST",
        data: $(this).serialize(),
        success: function(response){
          if(response.status === 'login'){
            window.location.href = response.redirect_url;
          } else {
            showMessage(response.message);
          }
        }
      });
    });
  </script>

</body>
</html>
